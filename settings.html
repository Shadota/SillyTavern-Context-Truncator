<div id="context_truncator_settings">
    <div class="inline-drawer">
        <div class="inline-drawer-toggle inline-drawer-header">
            <b>Enhanced Memory (Truncation + Qdrant)</b>
            <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
        </div>
        <div class="inline-drawer-content">
            
            <!-- Tab Navigation -->
            <div class="ct_tabs">
                <button class="ct_tab ct_tab_active" data-tab="overview">
                    <i class="fa-solid fa-chart-pie"></i> Overview
                </button>
                <button class="ct_tab" data-tab="truncation">
                    <i class="fa-solid fa-scissors"></i> Truncation
                </button>
                <button class="ct_tab" data-tab="qdrant">
                    <i class="fa-solid fa-brain"></i> Qdrant Memory
                </button>
                <button class="ct_tab" data-tab="synergy">
                    <i class="fa-solid fa-link"></i> Synergy
                </button>
            </div>

            <!-- ==================== OVERVIEW TAB ==================== -->
            <div class="ct_tab_content ct_tab_content_active" data-tab="overview">
                
                <!-- Context Utilization Gauge -->
                <div class="ct_overview_section">
                    <h4><i class="fa-solid fa-gauge-high"></i> Context Utilization</h4>
                    <div class="ct_gauge_container">
                        <div class="ct_gauge_bar">
                            <div id="ct_gauge_fill" class="ct_gauge_fill ct_gauge_green" style="width: 0%"></div>
                            <div class="ct_gauge_markers">
                                <span class="ct_gauge_marker" style="left: 80%">80%</span>
                                <span class="ct_gauge_marker" style="left: 90%">90%</span>
                            </div>
                        </div>
                        <div class="ct_gauge_labels">
                            <span id="ct_gauge_value">--%</span>
                            <span id="ct_gauge_max">of -- tokens</span>
                        </div>
                    </div>
                </div>

                <!-- Context Breakdown Bar -->
                <div class="ct_overview_section">
                    <h4><i class="fa-solid fa-chart-bar"></i> Context Breakdown</h4>
                    <div class="ct_breakdown_container">
                        <div class="ct_breakdown_bar">
                            <div id="ct_breakdown_chat" class="ct_breakdown_segment ct_breakdown_chat" style="width: 0%"></div>
                            <div id="ct_breakdown_system" class="ct_breakdown_segment ct_breakdown_system" style="width: 0%"></div>
                            <div id="ct_breakdown_summaries" class="ct_breakdown_segment ct_breakdown_summaries" style="width: 0%"></div>
                            <div id="ct_breakdown_qdrant" class="ct_breakdown_segment ct_breakdown_qdrant" style="width: 0%"></div>
                            <div id="ct_breakdown_free" class="ct_breakdown_segment ct_breakdown_free" style="width: 100%"></div>
                        </div>
                        <div class="ct_breakdown_legend">
                            <span class="ct_legend_item"><span class="ct_legend_color ct_breakdown_chat"></span>Chat</span>
                            <span class="ct_legend_item"><span class="ct_legend_color ct_breakdown_system"></span>System</span>
                            <span class="ct_legend_item"><span class="ct_legend_color ct_breakdown_summaries"></span>Summaries</span>
                            <span class="ct_legend_item"><span class="ct_legend_color ct_breakdown_qdrant"></span>Qdrant</span>
                            <span class="ct_legend_item"><span class="ct_legend_color ct_breakdown_free"></span>Free</span>
                        </div>
                        <!-- Token Counts Foldable Section -->
                        <div class="ct_breakdown_details_toggle" id="ct_breakdown_toggle">
                            <span>Show Token Counts</span>
                            <i class="fa-solid fa-chevron-down"></i>
                        </div>
                        <div class="ct_breakdown_details" id="ct_breakdown_details" style="display: none;">
                            <div class="ct_breakdown_detail_row">
                                <span class="ct_breakdown_label"><span class="ct_legend_color ct_breakdown_chat"></span>Chat</span>
                                <span id="ct_breakdown_chat_tokens" class="ct_breakdown_value">-- tokens</span>
                            </div>
                            <div class="ct_breakdown_detail_row">
                                <span class="ct_breakdown_label"><span class="ct_legend_color ct_breakdown_system"></span>System</span>
                                <span id="ct_breakdown_system_tokens" class="ct_breakdown_value">-- tokens</span>
                            </div>
                            <div class="ct_breakdown_detail_row">
                                <span class="ct_breakdown_label"><span class="ct_legend_color ct_breakdown_summaries"></span>Summaries</span>
                                <span id="ct_breakdown_summaries_tokens" class="ct_breakdown_value">-- tokens</span>
                            </div>
                            <div class="ct_breakdown_detail_row">
                                <span class="ct_breakdown_label"><span class="ct_legend_color ct_breakdown_qdrant"></span>Qdrant</span>
                                <span id="ct_breakdown_qdrant_tokens" class="ct_breakdown_value">-- tokens</span>
                            </div>
                            <div class="ct_breakdown_detail_row">
                                <span class="ct_breakdown_label"><span class="ct_legend_color ct_breakdown_free"></span>Free</span>
                                <span id="ct_breakdown_free_tokens" class="ct_breakdown_value">-- tokens</span>
                            </div>
                            <div class="ct_breakdown_detail_row ct_breakdown_total">
                                <span class="ct_breakdown_label"><strong>Total Used</strong></span>
                                <span id="ct_breakdown_total_tokens" class="ct_breakdown_value"><strong>-- / -- tokens</strong></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stats Cards Grid -->
                <div class="ct_stats_grid">
                    
                    <!-- Next Events Card (Predictions) - FIRST -->
                    <div class="ct_stats_card ct_collapsible" data-collapsed="false">
                        <div class="ct_card_header ct_collapsible_toggle">
                            <div class="ct_card_header_left">
                                <i class="fa-solid fa-clock"></i>
                                <span>Next Events</span>
                            </div>
                            <i class="fa-solid fa-chevron-down ct_collapse_icon"></i>
                        </div>
                        <div class="ct_card_content ct_collapsible_content">
                            <div class="ct_stat_row">
                                <span class="ct_stat_label">Next Trim</span>
                                <span id="ct_ov_next_trim" class="ct_stat_value">--</span>
                            </div>
                            <div class="ct_stat_row">
                                <span class="ct_stat_label">Room Left</span>
                                <span id="ct_ov_room_left" class="ct_stat_value">--</span>
                            </div>
                            <div class="ct_stat_row">
                                <span class="ct_stat_label">Calibration</span>
                                <span id="ct_ov_cal_status" class="ct_stat_value">--</span>
                            </div>
                            <div class="ct_prediction_disclaimer">
                                <small><i class="fa-solid fa-info-circle"></i> Estimates based on recent message sizes</small>
                            </div>
                        </div>
                    </div>

                    <!-- Truncation Stats Card -->
                    <div class="ct_stats_card ct_collapsible" data-collapsed="false">
                        <div class="ct_card_header ct_collapsible_toggle">
                            <div class="ct_card_header_left">
                                <i class="fa-solid fa-scissors"></i>
                                <span>Truncation Stats</span>
                            </div>
                            <i class="fa-solid fa-chevron-down ct_collapse_icon"></i>
                        </div>
                        <div class="ct_card_content ct_collapsible_content">
                            <div class="ct_stat_row">
                                <span class="ct_stat_label">Actual Size</span>
                                <span id="ct_ov_actual_size" class="ct_stat_value">--</span>
                            </div>
                            <div class="ct_stat_row">
                                <span class="ct_stat_label">Target Size</span>
                                <span id="ct_ov_target_size" class="ct_stat_value">--</span>
                            </div>
                            <div class="ct_stat_row">
                                <span class="ct_stat_label">Difference</span>
                                <span id="ct_ov_difference" class="ct_stat_value">--</span>
                            </div>
                            <div class="ct_stat_row">
                                <span class="ct_stat_label">Error</span>
                                <span id="ct_ov_error" class="ct_stat_value">--</span>
                            </div>
                            <div class="ct_stat_row">
                                <span class="ct_stat_label">Truncation Index</span>
                                <span id="ct_ov_trunc_index" class="ct_stat_value">--</span>
                            </div>
                            <div class="ct_stat_row">
                                <span class="ct_stat_label">Correction Factor</span>
                                <span id="ct_ov_correction" class="ct_stat_value">--</span>
                            </div>
                        </div>
                    </div>

                    <!-- Calibration Status Card -->
                    <div class="ct_stats_card ct_collapsible" data-collapsed="false">
                        <div class="ct_card_header ct_collapsible_toggle">
                            <div class="ct_card_header_left">
                                <i class="fa-solid fa-chart-line"></i>
                                <span>Calibration Status</span>
                            </div>
                            <i class="fa-solid fa-chevron-down ct_collapse_icon"></i>
                        </div>
                        <div class="ct_card_content ct_collapsible_content">
                            <div class="ct_stat_row">
                                <span class="ct_stat_label">Phase</span>
                                <span id="ct_ov_cal_phase" class="ct_stat_value">--</span>
                            </div>
                            <div class="ct_stat_row">
                                <span class="ct_stat_label">Progress</span>
                                <span id="ct_ov_cal_progress" class="ct_stat_value">--</span>
                            </div>
                            <div class="ct_stat_row">
                                <span class="ct_stat_label">Current Target</span>
                                <span id="ct_ov_cal_target" class="ct_stat_value">--</span>
                            </div>
                            <div class="ct_stat_row">
                                <span class="ct_stat_label">Utilization</span>
                                <span id="ct_ov_cal_util" class="ct_stat_value">--</span>
                            </div>
                            <div class="ct_stat_row">
                                <span class="ct_stat_label">Message Changes</span>
                                <span id="ct_ov_deletion_count" class="ct_stat_value ct_text_green">0/3</span>
                            </div>
                        </div>
                    </div>

                    <!-- Summarization Stats Card -->
                    <div class="ct_stats_card ct_collapsible" data-collapsed="false">
                        <div class="ct_card_header ct_collapsible_toggle">
                            <div class="ct_card_header_left">
                                <i class="fa-solid fa-file-lines"></i>
                                <span>Summarization</span>
                            </div>
                            <i class="fa-solid fa-chevron-down ct_collapse_icon"></i>
                        </div>
                        <div class="ct_card_content ct_collapsible_content">
                            <div class="ct_stat_row">
                                <span class="ct_stat_label">Total Messages</span>
                                <span id="ct_ov_sum_total" class="ct_stat_value">--</span>
                            </div>
                            <div class="ct_stat_row">
                                <span class="ct_stat_label">Summarized</span>
                                <span id="ct_ov_sum_done" class="ct_stat_value ct_text_green">--</span>
                            </div>
                            <div class="ct_stat_row">
                                <span class="ct_stat_label">Pending</span>
                                <span id="ct_ov_sum_pending" class="ct_stat_value ct_text_yellow">--</span>
                            </div>
                            <div class="ct_stat_row">
                                <span class="ct_stat_label">In Queue</span>
                                <span id="ct_ov_sum_queue" class="ct_stat_value ct_text_orange">--</span>
                            </div>
                            <div class="ct_stat_row">
                                <span class="ct_stat_label">In Context</span>
                                <span id="ct_ov_sum_active" class="ct_stat_value ct_text_blue">--</span>
                            </div>
                            <div class="ct_stat_row">
                                <span class="ct_stat_label">N/A</span>
                                <span id="ct_ov_sum_na" class="ct_stat_value ct_text_gray">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Qdrant Memory Card (Collapsible) -->
                <div class="ct_overview_section">
                    <div class="ct_memory_panel">
                        <div class="ct_memory_panel_header" id="ct_ov_memory_toggle">
                            <span>
                                <i class="fa-solid fa-brain"></i>
                                <span id="ct_ov_memory_count">Retrieved Memories (Last Generation)</span>
                            </span>
                            <i class="fa-solid fa-chevron-down ct_memory_toggle_icon"></i>
                        </div>
                        <div class="ct_memory_panel_content" id="ct_ov_memory_list" style="display: none;">
                            <div class="ct_memory_empty">Generate a message to retrieve memories</div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions Row -->
                <div class="ct_overview_section">
                    <h4><i class="fa-solid fa-bolt"></i> Quick Actions</h4>
                    <div class="ct_quick_actions">
                        <button id="ct_ov_reset" class="menu_button">
                            <i class="fa-solid fa-rotate-left"></i>
                            <span>Reset Truncation</span>
                        </button>
                        <button id="ct_ov_recalibrate" class="menu_button">
                            <i class="fa-solid fa-sync"></i>
                            <span>Recalibrate</span>
                        </button>
                        <button id="ct_ov_summarize" class="menu_button">
                            <i class="fa-solid fa-compress"></i>
                            <span>Summarize All</span>
                        </button>
                    </div>
                </div>

            </div>

            <!-- ==================== TRUNCATION TAB ==================== -->
            <div class="ct_tab_content" data-tab="truncation">
                
                <!-- Enable/Disable -->
                <div class="flex-container flexFlowColumn">
                    <label class="checkbox_label" for="ct_enabled">
                        <input id="ct_enabled" type="checkbox" />
                        <span>Enable Context Truncator</span>
                    </label>
                    <small>Enable or disable context truncation</small>
                </div>

                <hr>

                <!-- Target Settings (Target Size + Auto-Calibration) -->
                <h4>Target Settings</h4>
                
                <div class="flex-container flexFlowColumn">
                    <label for="ct_target_size">
                        <span>Target Context Size (tokens)</span>
                    </label>
                    <input id="ct_target_size" class="text_pole" type="number" min="1000" max="200000" step="1000" />
                    <small>Target prompt size in tokens. The extension learns and adapts over 2-3 generations to reach this target. Typical accuracy: 10-15% (conservative, under target).</small>
                </div>

                <div class="flex-container flexFlowColumn">
                    <label class="checkbox_label" for="ct_auto_calibrate">
                        <input id="ct_auto_calibrate" type="checkbox" />
                        <span>Enable Auto-Calibration</span>
                    </label>
                    <small>Automatically find optimal target_context_size based on your max context. Trains over several generations.</small>
                </div>

                <div class="flex-container flexFlowColumn">
                    <label for="ct_target_utilization">
                        <span>Target Utilization: <span id="ct_target_utilization_display">80%</span></span>
                    </label>
                    <input id="ct_target_utilization" class="text_pole" type="range" min="0.5" max="0.95" step="0.05" value="0.80" />
                    <small>How much of max context to use (80% recommended for safety margin)</small>
                </div>

                <div class="flex-container flexFlowColumn">
                    <label for="ct_calibration_tolerance">
                        <span>Tolerance: <span id="ct_calibration_tolerance_display">5%</span></span>
                    </label>
                    <input id="ct_calibration_tolerance" class="text_pole" type="range" min="0.02" max="0.15" step="0.01" value="0.05" />
                    <small>Acceptable deviation from target utilization before re-calibrating</small>
                </div>

                <div class="flex-container flexFlowColumn" style="margin-top: 10px;">
                    <button id="ct_recalibrate" class="menu_button">
                        <i class="fa-solid fa-sync"></i>
                        <span>Recalibrate</span>
                    </button>
                    <small>Reset calibration and start training from scratch</small>
                </div>

                <hr>

                <!-- Truncation Behavior -->
                <h4>Truncation Behavior</h4>

                <div class="flex-container flexFlowColumn">
                    <label for="ct_batch_size">
                        <span>Batch Size (messages)</span>
                    </label>
                    <input id="ct_batch_size" class="text_pole" type="number" min="1" max="100" step="1" />
                    <small>Number of messages to truncate at once. Larger batches are more cache-efficient.</small>
                </div>

                <div class="flex-container flexFlowColumn">
                    <label for="ct_min_keep">
                        <span>Minimum Messages to Keep</span>
                    </label>
                    <input id="ct_min_keep" class="text_pole" type="number" min="1" max="100" step="1" />
                    <small>Minimum number of recent messages to always keep in context (safety limit).</small>
                </div>

                <hr>

                <!-- Summarization Settings -->
                <h4>Summarization Settings</h4>
                
                <div class="flex-container flexFlowColumn">
                    <label class="checkbox_label" for="ct_auto_summarize">
                        <input id="ct_auto_summarize" type="checkbox" />
                        <span>Auto-Summarize Messages</span>
                    </label>
                    <small>Automatically summarize messages when they are truncated from context</small>
                </div>

                <div class="flex-container flexFlowColumn">
                    <label for="ct_connection_profile">
                        <span>Connection Profile</span>
                    </label>
                    <select id="ct_connection_profile" class="text_pole"></select>
                    <small>Choose a different model for summarization. "Same as Current" uses your main model. Allows background summarization while roleplaying.</small>
                </div>

                <div class="flex-container flexFlowColumn">
                    <label for="ct_max_words">
                        <span>Maximum Words per Summary</span>
                    </label>
                    <input id="ct_max_words" class="text_pole" type="number" min="10" max="200" step="5" />
                    <small>Maximum number of words allowed in each summary (default: 50)</small>
                </div>

                <div class="flex-container flexFlowColumn">
                    <button id="ct_summarize_all" class="menu_button">
                        <i class="fa-solid fa-compress"></i>
                        <span>Summarize All Messages</span>
                    </button>
                    <small>Manually summarize all messages in the current chat that don't have summaries yet</small>
                </div>

                <hr>

                <!-- Controls -->
                <h4>Controls</h4>
                
                <div class="flex-container flexFlowColumn">
                    <button id="ct_reset" class="menu_button">
                        <i class="fa-solid fa-rotate-left"></i>
                        <span>Reset Truncation</span>
                    </button>
                    <small>Reset truncation index and restart adaptive learning. Use this if you change target size or want to recalculate from scratch.</small>
                </div>

                <hr>

                <!-- Debug Mode - Truncation -->
                <div class="flex-container flexFlowColumn">
                    <label class="checkbox_label" for="ct_debug_truncation">
                        <input id="ct_debug_truncation" type="checkbox" />
                        <span>Debug Mode (Truncation)</span>
                    </label>
                    <small>Enable detailed console logging for truncation calculations, token estimates, and calibration</small>
                </div>

            </div>

            <!-- ==================== QDRANT MEMORY TAB ==================== -->
            <div class="ct_tab_content" data-tab="qdrant">
                
                <!-- Master Enable/Disable -->
                <div class="flex-container flexFlowColumn">
                    <label class="checkbox_label" for="ct_qdrant_enabled">
                        <input id="ct_qdrant_enabled" type="checkbox" />
                        <span><strong>Enable Qdrant Vector Memory</strong></span>
                    </label>
                    <small>Enable semantic memory retrieval from Qdrant vector database</small>
                </div>

                <hr>

                <!-- Connection Settings -->
                <h4>Connection Settings</h4>
                
                <div class="flex-container flexFlowColumn">
                    <label for="ct_qdrant_url">
                        <span>Qdrant URL</span>
                    </label>
                    <input id="ct_qdrant_url" class="text_pole" type="text" placeholder="http://localhost:6333" />
                    <small>URL of your Qdrant instance</small>
                </div>

                <div class="flex-container flexFlowColumn">
                    <label for="ct_qdrant_collection">
                        <span>Base Collection Name</span>
                    </label>
                    <input id="ct_qdrant_collection" class="text_pole" type="text" placeholder="sillytavern_memories" />
                    <small>Base name for collections (character/chat name will be appended)</small>
                </div>

                <div class="flex-container flexFlowColumn">
                    <button id="ct_qdrant_test" class="menu_button">
                        <i class="fa-solid fa-plug"></i>
                        <span>Test Connection</span>
                    </button>
                    <div id="ct_qdrant_status" class="ct_status_message" style="margin-top: 8px;"></div>
                </div>

                <hr>

                <!-- Embedding Settings (Local/KoboldCPP Only) -->
                <h4>Embedding Settings</h4>
                
                <div class="flex-container flexFlowColumn">
                    <label for="ct_embedding_url">
                        <span>Embedding Endpoint URL</span>
                    </label>
                    <input id="ct_embedding_url" class="text_pole" type="text" placeholder="http://localhost:5001/api/extra/embeddings" />
                    <small>KoboldCPP or compatible embedding endpoint (OpenAI-compatible format)</small>
                </div>

                <div class="flex-container flexFlowColumn">
                    <label for="ct_embedding_api_key">
                        <span>Embedding API Key (optional)</span>
                    </label>
                    <input id="ct_embedding_api_key" class="text_pole" type="password" placeholder="Leave empty if not required" />
                    <small>Bearer token if your endpoint requires authentication</small>
                </div>

                <div class="flex-container flexFlowColumn">
                    <label for="ct_embedding_dimensions">
                        <span>Embedding Dimensions (auto-detected)</span>
                    </label>
                    <input id="ct_embedding_dimensions" class="text_pole" type="number" min="1" step="1" placeholder="Auto-detect on first use" />
                    <small>Vector size returned by your embedding model. Leave blank to auto-detect.</small>
                </div>

                <div class="flex-container flexFlowColumn">
                    <button id="ct_test_embedding" class="menu_button">
                        <i class="fa-solid fa-vial"></i>
                        <span>Test Embedding</span>
                    </button>
                    <div id="ct_embedding_status" class="ct_status_message" style="margin-top: 8px;"></div>
                </div>

                <hr>

                <!-- Memory Retrieval Settings -->
                <h4>Memory Retrieval</h4>

                <div class="flex-container flexFlowColumn">
                    <label for="ct_memory_limit">
                        <span>Number of Memories: <span id="ct_memory_limit_display">5</span></span>
                    </label>
                    <input id="ct_memory_limit" class="text_pole" type="range" min="1" max="20" value="5" />
                    <small>Maximum memories to retrieve per generation</small>
                </div>

                <div class="flex-container flexFlowColumn">
                    <label for="ct_score_threshold">
                        <span>Relevance Threshold: <span id="ct_score_threshold_display">0.3</span></span>
                    </label>
                    <input id="ct_score_threshold" class="text_pole" type="range" min="0" max="1" step="0.05" value="0.3" />
                    <small>Minimum similarity score (0.0 - 1.0). Higher = more relevant results only.</small>
                </div>

                <div class="flex-container flexFlowColumn">
                    <label for="ct_memory_position">
                        <span>Memory Position: <span id="ct_memory_position_display">2</span></span>
                    </label>
                    <input id="ct_memory_position" class="text_pole" type="range" min="1" max="30" value="2" />
                    <small>Insert memories N messages from the end of chat</small>
                </div>

                <div class="flex-container flexFlowColumn">
                    <label for="ct_retain_recent">
                        <span>Exclude Recent Messages: <span id="ct_retain_recent_display">5</span></span>
                    </label>
                    <input id="ct_retain_recent" class="text_pole" type="range" min="0" max="50" value="5" />
                    <small>Don't retrieve memories from the last N messages (they're already in context)</small>
                </div>

                <div class="flex-container flexFlowColumn">
                    <label for="ct_qdrant_min_messages">
                        <span>Minimum Messages: <span id="ct_qdrant_min_messages_display">20</span></span>
                    </label>
                    <input id="ct_qdrant_min_messages" class="text_pole" type="range" min="0" max="100" step="5" value="20" />
                    <small>Only retrieve memories after chat has at least this many messages. Early messages are unlikely to have relevant matches.</small>
                </div>

                <hr>

                <!-- Automatic Memory Creation -->
                <h4>Automatic Memory Creation</h4>

                <div class="flex-container flexFlowColumn">
                    <label class="checkbox_label" for="ct_auto_save_memories">
                        <input id="ct_auto_save_memories" type="checkbox" checked />
                        <span>Auto-Save Memories</span>
                    </label>
                    <small>Automatically save messages to Qdrant as conversations happen</small>
                </div>

                <div class="flex-container flexFlowColumn">
                    <label class="checkbox_label" for="ct_save_user_messages">
                        <input id="ct_save_user_messages" type="checkbox" checked />
                        <span>Save User Messages</span>
                    </label>
                </div>

                <div class="flex-container flexFlowColumn">
                    <label class="checkbox_label" for="ct_save_char_messages">
                        <input id="ct_save_char_messages" type="checkbox" checked />
                        <span>Save Character Messages</span>
                    </label>
                </div>

                <div class="flex-container flexFlowColumn">
                    <label class="checkbox_label" for="ct_per_chat_collection">
                        <input id="ct_per_chat_collection" type="checkbox" checked />
                        <span>Use Per-Chat Collections</span>
                    </label>
                    <small>Each chat gets its own collection (recommended). Otherwise all chats share one collection per character.</small>
                </div>

                <hr>

                <!-- Memory Management -->
                <h4>Memory Management</h4>

                <div class="flex-container flexFlowColumn">
                    <button id="ct_index_chats" class="menu_button">
                        <i class="fa-solid fa-database"></i>
                        <span>Index Current Chat</span>
                    </button>
                    <small>Index all messages from current chat to Qdrant</small>
                </div>

                <div class="flex-container flexFlowColumn" style="margin-top: 10px;">
                    <button id="ct_delete_collection" class="menu_button menu_button_danger">
                        <i class="fa-solid fa-trash"></i>
                        <span>Delete Collection</span>
                    </button>
                    <small>Delete all memories for current character/chat</small>
                </div>

                <hr>

                <!-- Retrieved Memories Display -->
                <h4>Retrieved Memories (Last Generation)</h4>
                
                <div id="ct_memory_display_panel" class="ct_memory_panel">
                    <div class="ct_memory_panel_header" id="ct_memory_panel_toggle">
                        <span>
                            <i class="fa-solid fa-brain"></i>
                            <span id="ct_memory_count">No memories retrieved</span>
                        </span>
                        <i class="fa-solid fa-chevron-down ct_memory_toggle_icon"></i>
                    </div>
                    <div class="ct_memory_panel_content" id="ct_memory_list" style="display: none;">
                        <!-- Memories will be populated here by JavaScript -->
                        <div class="ct_memory_empty">Generate a message to retrieve memories</div>
                    </div>
                </div>

                <hr>

                <!-- Debug Mode - Qdrant -->
                <div class="flex-container flexFlowColumn">
                    <label class="checkbox_label" for="ct_debug_qdrant">
                        <input id="ct_debug_qdrant" type="checkbox" />
                        <span>Debug Mode (Qdrant)</span>
                    </label>
                    <small>Enable console logging for Qdrant operations, embeddings, and memory retrieval</small>
                </div>

            </div>

            <!-- ==================== SYNERGY TAB ==================== -->
            <div class="ct_tab_content" data-tab="synergy">
                
                <div class="ct_info_box">
                    <i class="fa-solid fa-info-circle"></i>
                    <span>Synergy features combine truncation and Qdrant memory for enhanced functionality. Requires both systems to be enabled.</span>
                </div>

                <hr>

                <h4>Summary-as-Chunk</h4>
                
                <div class="flex-container flexFlowColumn">
                    <label class="checkbox_label" for="ct_use_summaries_for_qdrant">
                        <input id="ct_use_summaries_for_qdrant" type="checkbox" />
                        <span>Use Summaries for Qdrant Indexing</span>
                    </label>
                    <small>Index AI-generated summaries instead of raw messages. Faster/cheaper but may lose detail.</small>
                </div>

                <hr>

                <h4>Memory-Aware Summarization</h4>
                
                <div class="flex-container flexFlowColumn">
                    <label class="checkbox_label" for="ct_memory_aware_summaries">
                        <input id="ct_memory_aware_summaries" type="checkbox" />
                        <span>Include Memories in Summary Context</span>
                    </label>
                    <small>Retrieve relevant memories when generating summaries for better context.</small>
                </div>

                <hr>

                <h4>Token Accounting</h4>
                
                <div class="flex-container flexFlowColumn">
                    <label class="checkbox_label" for="ct_account_qdrant_tokens">
                        <input id="ct_account_qdrant_tokens" type="checkbox" checked />
                        <span>Account for Qdrant Tokens in Truncation</span>
                    </label>
                    <small>Adjust truncation target to account for injected Qdrant memories. Prevents context overflow.</small>
                </div>

                <hr>

                <!-- Info -->
                <div class="flex-container flexFlowColumn">
                    <small>
                        <b>How Synergy Works:</b><br>
                        1. Qdrant memories are retrieved based on current conversation<br>
                        2. If token accounting is enabled, truncation adjusts for memory size<br>
                        3. Summaries can optionally be indexed to Qdrant for semantic search<br>
                        4. Memory-aware summarization uses long-term context for better summaries<br>
                    </small>
                </div>

                <hr>

                <!-- Debug Mode - Synergy -->
                <div class="flex-container flexFlowColumn">
                    <label class="checkbox_label" for="ct_debug_synergy">
                        <input id="ct_debug_synergy" type="checkbox" />
                        <span>Debug Mode (Synergy)</span>
                    </label>
                    <small>Enable console logging for synergy features (token accounting, summary-as-chunk)</small>
                </div>

            </div>

        </div>
    </div>
</div>
