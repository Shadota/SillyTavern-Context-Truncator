<div id="context_truncator_settings">
    <div class="inline-drawer">
        <div class="inline-drawer-toggle inline-drawer-header">
            <b>Enhanced Memory (Truncation + Qdrant)</b>
            <div class="inline-drawer-icon fa-solid fa-circle-chevron-down down"></div>
        </div>
        <div class="inline-drawer-content">
            
            <!-- Tab Navigation -->
            <div class="ct_tabs">
                <button class="ct_tab ct_tab_active" data-tab="overview">
                    <i class="fa-solid fa-chart-pie"></i> Overview
                </button>
                <button class="ct_tab" data-tab="truncation">
                    <i class="fa-solid fa-scissors"></i> Truncation
                </button>
                <button class="ct_tab" data-tab="qdrant">
                    <i class="fa-solid fa-brain"></i> Qdrant Memory
                </button>
                <button class="ct_tab" data-tab="synergy">
                    <i class="fa-solid fa-link"></i> Synergy
                </button>
            </div>

            <!-- ==================== OVERVIEW TAB ==================== -->
            <div class="ct_tab_content ct_tab_content_active" data-tab="overview">
                
                <!-- Context Utilization Gauge -->
                <div class="ct_overview_section">
                    <h4><i class="fa-solid fa-gauge-high"></i> Context Utilization</h4>
                    <div class="ct_gauge_container">
                        <div class="ct_gauge_bar">
                            <div id="ct_gauge_fill" class="ct_gauge_fill ct_gauge_green" style="width: 0%"></div>
                            <div class="ct_gauge_markers">
                                <!-- Fixed 25% interval tick marks -->
                                <span class="ct_gauge_tick" style="left: 25%"></span>
                                <span class="ct_gauge_tick" style="left: 50%"></span>
                                <span class="ct_gauge_tick" style="left: 75%"></span>
                                <!-- Dynamic target marker (positioned by JS) -->
                                <span id="ct_gauge_target" class="ct_gauge_target_marker" style="left: 80%"></span>
                            </div>
                        </div>
                        <div class="ct_gauge_labels">
                            <span id="ct_gauge_value">--%</span>
                            <span id="ct_gauge_max">of -- tokens</span>
                        </div>
                    </div>
                </div>

                <!-- Context Breakdown Bar -->
                <div class="ct_overview_section">
                    <h4><i class="fa-solid fa-chart-bar"></i> Context Breakdown</h4>
                    <div class="ct_breakdown_container">
                        <div class="ct_breakdown_bar">
                            <div id="ct_breakdown_chat" class="ct_breakdown_segment ct_breakdown_chat" style="width: 0%"></div>
                            <div id="ct_breakdown_system" class="ct_breakdown_segment ct_breakdown_system" style="width: 0%"></div>
                            <div id="ct_breakdown_worldrules" class="ct_breakdown_segment ct_breakdown_worldrules" style="width: 0%"></div>
                            <div id="ct_breakdown_summaries" class="ct_breakdown_segment ct_breakdown_summaries" style="width: 0%"></div>
                            <div id="ct_breakdown_qdrant" class="ct_breakdown_segment ct_breakdown_qdrant" style="width: 0%"></div>
                            <div id="ct_breakdown_free" class="ct_breakdown_segment ct_breakdown_free" style="width: 100%"></div>
                        </div>
                        <div class="ct_breakdown_legend">
                            <span class="ct_legend_item"><span class="ct_legend_color ct_breakdown_chat"></span>Chat</span>
                            <span class="ct_legend_item"><span class="ct_legend_color ct_breakdown_system"></span>System</span>
                            <span class="ct_legend_item"><span class="ct_legend_color ct_breakdown_worldrules"></span>World Rules</span>
                            <span class="ct_legend_item"><span class="ct_legend_color ct_breakdown_summaries"></span>Summaries</span>
                            <span class="ct_legend_item"><span class="ct_legend_color ct_breakdown_qdrant"></span>Qdrant</span>
                            <span class="ct_legend_item"><span class="ct_legend_color ct_breakdown_free"></span>Free</span>
                        </div>
                        <!-- Token Counts Foldable Section -->
                        <div class="ct_breakdown_details_toggle" id="ct_breakdown_toggle">
                            <span>Show Token Counts</span>
                            <i class="fa-solid fa-chevron-down"></i>
                        </div>
                        <div class="ct_breakdown_details" id="ct_breakdown_details" style="display: none;">
                            <div class="ct_breakdown_detail_row">
                                <span class="ct_breakdown_label"><span class="ct_legend_color ct_breakdown_chat"></span>Chat</span>
                                <span id="ct_breakdown_chat_tokens" class="ct_breakdown_value">-- tokens</span>
                            </div>
                            <div class="ct_breakdown_detail_row">
                                <span class="ct_breakdown_label"><span class="ct_legend_color ct_breakdown_system"></span>System</span>
                                <span id="ct_breakdown_system_tokens" class="ct_breakdown_value">-- tokens</span>
                            </div>
                            <div class="ct_breakdown_detail_row">
                                <span class="ct_breakdown_label"><span class="ct_legend_color ct_breakdown_worldrules"></span>World Rules</span>
                                <span id="ct_breakdown_worldrules_tokens" class="ct_breakdown_value">-- tokens</span>
                            </div>
                            <div class="ct_breakdown_detail_row">
                                <span class="ct_breakdown_label"><span class="ct_legend_color ct_breakdown_summaries"></span>Summaries</span>
                                <span id="ct_breakdown_summaries_tokens" class="ct_breakdown_value">-- tokens</span>
                            </div>
                            <div class="ct_breakdown_detail_row">
                                <span class="ct_breakdown_label"><span class="ct_legend_color ct_breakdown_qdrant"></span>Qdrant</span>
                                <span id="ct_breakdown_qdrant_tokens" class="ct_breakdown_value">-- tokens</span>
                            </div>
                            <div class="ct_breakdown_detail_row">
                                <span class="ct_breakdown_label"><span class="ct_legend_color ct_breakdown_free"></span>Free</span>
                                <span id="ct_breakdown_free_tokens" class="ct_breakdown_value">-- tokens</span>
                            </div>
                            <div class="ct_breakdown_detail_row ct_breakdown_total">
                                <span class="ct_breakdown_label"><strong>Total Used</strong></span>
                                <span id="ct_breakdown_total_tokens" class="ct_breakdown_value"><strong>-- / -- tokens</strong></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Simplified Stats Cards Grid -->
                <div class="ct_stats_grid ct_stats_grid_compact">
                    
                    <!-- Status Card (merged Truncation + Calibration essentials) -->
                    <div class="ct_stats_card">
                        <div class="ct_card_header">
                            <div class="ct_card_header_left">
                                <i class="fa-solid fa-chart-line"></i>
                                <span>Status</span>
                            </div>
                        </div>
                        <div class="ct_card_content">
                            <div class="ct_stat_row">
                                <span class="ct_stat_label ct_tooltip">
                                    Phase
                                    <i class="fa-solid fa-circle-info ct_info_icon"></i>
                                    <span class="ct_tooltip_text">Calibration state: WAITING → TRAINING → CALIBRATING → STABLE</span>
                                </span>
                                <span id="ct_ov_cal_phase" class="ct_stat_value">--</span>
                            </div>
                            <div class="ct_stat_row">
                                <span class="ct_stat_label ct_tooltip">
                                    Next Trim
                                    <i class="fa-solid fa-circle-info ct_info_icon"></i>
                                    <span class="ct_tooltip_text">Estimated generations until context truncation occurs</span>
                                </span>
                                <span id="ct_ov_next_trim" class="ct_stat_value">--</span>
                            </div>
                            <div class="ct_stat_row">
                                <span class="ct_stat_label ct_tooltip">
                                    Context
                                    <i class="fa-solid fa-circle-info ct_info_icon"></i>
                                    <span class="ct_tooltip_text">Current actual size / target size in tokens</span>
                                </span>
                                <span id="ct_ov_context" class="ct_stat_value">
                                    <span class="ct_context_combined">
                                        <span id="ct_ov_actual_size_short" class="ct_actual">--</span>
                                        <span class="ct_separator">/</span>
                                        <span id="ct_ov_target_size_short" class="ct_target">--</span>
                                    </span>
                                </span>
                            </div>
                        </div>
                    </div>
    
                    <!-- Summaries Card (simplified) -->
                    <div class="ct_stats_card">
                        <div class="ct_card_header">
                            <div class="ct_card_header_left">
                                <i class="fa-solid fa-file-lines"></i>
                                <span>Summaries</span>
                            </div>
                        </div>
                        <div class="ct_card_content">
                            <div class="ct_stat_row">
                                <span class="ct_stat_label ct_tooltip">
                                    Progress
                                    <i class="fa-solid fa-circle-info ct_info_icon"></i>
                                    <span class="ct_tooltip_text">Summarized messages / total truncated messages</span>
                                </span>
                                <span id="ct_ov_sum_progress" class="ct_stat_value">
                                    <span id="ct_ov_sum_done">--</span> / <span id="ct_ov_sum_total">--</span>
                                </span>
                            </div>
                            <div class="ct_stat_row">
                                <span class="ct_stat_label ct_tooltip">
                                    In Context
                                    <i class="fa-solid fa-circle-info ct_info_icon"></i>
                                    <span class="ct_tooltip_text">Messages still in active context (not truncated)</span>
                                </span>
                                <span id="ct_ov_sum_active" class="ct_stat_value">--</span>
                            </div>
                        </div>
                    </div>
                </div>
    
                <!-- Advanced Stats (collapsed by default) -->
                <div class="ct_overview_section">
                    <div class="ct_advanced_toggle" id="ct_advanced_toggle">
                        <span><i class="fa-solid fa-cog"></i> Advanced Stats</span>
                        <i class="fa-solid fa-chevron-down"></i>
                    </div>
                    <div class="ct_advanced_content" id="ct_advanced_content" style="display: none;">
                        <div class="ct_advanced_grid">
                            <div class="ct_advanced_item">
                                <span class="ct_advanced_label ct_tooltip">
                                    Correction
                                    <i class="fa-solid fa-circle-info ct_info_icon"></i>
                                    <span class="ct_tooltip_text">Learned multiplier for token estimation accuracy (1.0 = perfect)</span>
                                </span>
                                <span id="ct_ov_correction" class="ct_advanced_value">--</span>
                            </div>
                            <div class="ct_advanced_item">
                                <span class="ct_advanced_label ct_tooltip">
                                    Trunc. Index
                                    <i class="fa-solid fa-circle-info ct_info_icon"></i>
                                    <span class="ct_tooltip_text">Message index where truncation begins (0 = no truncation)</span>
                                </span>
                                <span id="ct_ov_trunc_index" class="ct_advanced_value">--</span>
                            </div>
                            <div class="ct_advanced_item">
                                <span class="ct_advanced_label ct_tooltip">
                                    Msg Changes
                                    <i class="fa-solid fa-circle-info ct_info_icon"></i>
                                    <span class="ct_tooltip_text">Message deletions since stable state. Recalibrates at 3.</span>
                                </span>
                                <span id="ct_ov_deletion_count" class="ct_advanced_value ct_text_green">0/3</span>
                            </div>
                            <div class="ct_advanced_item">
                                <span class="ct_advanced_label ct_tooltip">
                                    Cal. Progress
                                    <i class="fa-solid fa-circle-info ct_info_icon"></i>
                                    <span class="ct_tooltip_text">Progress toward stable calibration</span>
                                </span>
                                <span id="ct_ov_cal_progress" class="ct_advanced_value">--</span>
                            </div>
                            <div class="ct_advanced_item">
                                <span class="ct_advanced_label ct_tooltip">
                                    Difference
                                    <i class="fa-solid fa-circle-info ct_info_icon"></i>
                                    <span class="ct_tooltip_text">Actual size minus target size</span>
                                </span>
                                <span id="ct_ov_difference" class="ct_advanced_value">--</span>
                            </div>
                            <div class="ct_advanced_item">
                                <span class="ct_advanced_label ct_tooltip">
                                    Room Left
                                    <i class="fa-solid fa-circle-info ct_info_icon"></i>
                                    <span class="ct_tooltip_text">Tokens remaining before target exceeded</span>
                                </span>
                                <span id="ct_ov_room_left" class="ct_advanced_value">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Qdrant Memory Card (Collapsible) -->
                <div class="ct_overview_section">
                    <div class="ct_memory_panel">
                        <div class="ct_memory_panel_header" id="ct_ov_memory_toggle">
                            <span>
                                <i class="fa-solid fa-brain"></i>
                                <span id="ct_ov_memory_count">Retrieved Memories (Last Generation)</span>
                            </span>
                            <i class="fa-solid fa-chevron-down ct_memory_toggle_icon"></i>
                        </div>
                        <div class="ct_memory_panel_content" id="ct_ov_memory_list" style="display: none;">
                            <div class="ct_memory_empty">Generate a message to retrieve memories</div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions Row -->
                <div class="ct_overview_section">
                    <h4><i class="fa-solid fa-bolt"></i> Quick Actions</h4>
                    <div class="ct_button_row">
                        <button id="ct_ov_reset" class="menu_button" title="Reset truncation index and restart adaptive learning">
                            <i class="fa-solid fa-rotate-left"></i> Reset
                        </button>
                        <button id="ct_ov_recalibrate" class="menu_button" title="Reset calibration and start training from scratch">
                            <i class="fa-solid fa-sync"></i> Recalibrate
                        </button>
                        <button id="ct_ov_summarize" class="menu_button" title="Summarize all messages without summaries">
                            <i class="fa-solid fa-compress"></i> Summarize All
                        </button>
                        <button id="ct_ov_stop_summarize" class="menu_button menu_button_danger" title="Stop the current summarization queue" style="display: none;">
                            <i class="fa-solid fa-stop"></i> Stop
                        </button>
                    </div>
                </div>

            </div>

            <!-- ==================== TRUNCATION TAB ==================== -->
            <div class="ct_tab_content" data-tab="truncation">
                
                <!-- Enable/Disable -->
                <div class="ct_compact_checkbox">
                    <input id="ct_enabled" type="checkbox" />
                    <label for="ct_enabled">Enable Context Truncator</label>
                    <span class="ct_tooltip ct_tooltip_right">
                        <i class="fa-solid fa-circle-info ct_info_icon"></i>
                        <span class="ct_tooltip_text">Master switch for context truncation. When enabled, messages are excluded from context once target size is reached.</span>
                    </span>
                </div>

                <hr class="ct_section_divider">

                <!-- Target Settings -->
                <div class="ct_section_header">
                    <i class="fa-solid fa-crosshairs"></i>
                    <span>Target Settings</span>
                </div>
                
                <div class="ct_compact_setting">
                    <div class="ct_setting_header">
                        <span class="ct_setting_label">
                            Target Size
                            <span class="ct_tooltip">
                                <i class="fa-solid fa-circle-info ct_info_icon"></i>
                                <span class="ct_tooltip_text">Target prompt size in tokens. The extension learns and adapts over 2-3 generations. Disabled when Auto-Calibration is on.</span>
                            </span>
                        </span>
                        <span class="ct_setting_value"><span id="ct_target_size_display">--</span> tokens</span>
                    </div>
                    <input id="ct_target_size" class="text_pole" type="number" min="1000" max="200000" step="1000" />
                </div>

                <div class="ct_compact_checkbox">
                    <input id="ct_auto_calibrate" type="checkbox" />
                    <label for="ct_auto_calibrate">Auto-Calibration</label>
                    <span class="ct_tooltip ct_tooltip_right">
                        <i class="fa-solid fa-circle-info ct_info_icon"></i>
                        <span class="ct_tooltip_text">Automatically find optimal target size based on max context. Trains over several generations to achieve your target utilization.</span>
                    </span>
                </div>

                <div class="ct_compact_setting">
                    <div class="ct_setting_header">
                        <span class="ct_setting_label">
                            Utilization
                            <span class="ct_tooltip">
                                <i class="fa-solid fa-circle-info ct_info_icon"></i>
                                <span class="ct_tooltip_text">How much of max context to use. 80% recommended for safety margin against overflow.</span>
                            </span>
                        </span>
                        <span id="ct_target_utilization_display" class="ct_setting_value">80%</span>
                    </div>
                    <input id="ct_target_utilization" class="ct_compact_slider" type="range" min="0.5" max="0.95" step="0.05" value="0.80" />
                </div>

                <div class="ct_compact_setting">
                    <div class="ct_setting_header">
                        <span class="ct_setting_label">
                            Tolerance
                            <span class="ct_tooltip">
                                <i class="fa-solid fa-circle-info ct_info_icon"></i>
                                <span class="ct_tooltip_text">Acceptable deviation from target before re-calibrating. Higher = more stable, lower = more precise.</span>
                            </span>
                        </span>
                        <span id="ct_calibration_tolerance_display" class="ct_setting_value">5%</span>
                    </div>
                    <input id="ct_calibration_tolerance" class="ct_compact_slider" type="range" min="0.02" max="0.15" step="0.01" value="0.05" />
                </div>

                <hr class="ct_section_divider">

                <!-- Summarization Settings -->
                <div class="ct_section_header">
                    <i class="fa-solid fa-file-lines"></i>
                    <span>Summarization</span>
                </div>
                
                <div class="ct_compact_checkbox">
                    <input id="ct_auto_summarize" type="checkbox" />
                    <label for="ct_auto_summarize">Auto-Summarize</label>
                    <span class="ct_tooltip ct_tooltip_right">
                        <i class="fa-solid fa-circle-info ct_info_icon"></i>
                        <span class="ct_tooltip_text">Automatically summarize messages when truncated from context. Summaries are injected back for continuity.</span>
                    </span>
                </div>

                <div class="ct_compact_input">
                    <label for="ct_connection_profile">
                        Connection Profile
                        <span class="ct_tooltip">
                            <i class="fa-solid fa-circle-info ct_info_icon"></i>
                            <span class="ct_tooltip_text">Use a different model for summarization. "Same as Current" uses your main model.</span>
                        </span>
                    </label>
                    <select id="ct_connection_profile" class="text_pole"></select>
                </div>

                <div class="ct_compact_setting">
                    <div class="ct_setting_header">
                        <span class="ct_setting_label">
                            Max Words
                            <span class="ct_tooltip">
                                <i class="fa-solid fa-circle-info ct_info_icon"></i>
                                <span class="ct_tooltip_text">Maximum words per summary. Shorter = more token-efficient, longer = more detail preserved.</span>
                            </span>
                        </span>
                        <span id="ct_max_words_display" class="ct_setting_value">50</span>
                    </div>
                    <input id="ct_max_words" class="ct_compact_slider" type="range" min="10" max="200" step="5" value="50" />
                </div>

                <hr class="ct_section_divider">

                <!-- Quick Actions -->
                <div class="ct_button_row">
                    <button id="ct_reset" class="menu_button" title="Reset truncation index and restart adaptive learning">
                        <i class="fa-solid fa-rotate-left"></i> Reset
                    </button>
                    <button id="ct_recalibrate" class="menu_button" title="Reset calibration and start training from scratch">
                        <i class="fa-solid fa-sync"></i> Recalibrate
                    </button>
                    <button id="ct_summarize_all" class="menu_button" title="Summarize all messages without summaries">
                        <i class="fa-solid fa-compress"></i> Summarize All
                    </button>
                    <button id="ct_stop_summarize" class="menu_button menu_button_danger" title="Stop the current summarization queue" style="display: none;">
                        <i class="fa-solid fa-stop"></i> Stop
                    </button>
                </div>

                <hr class="ct_section_divider">

                <!-- Advanced Settings (Collapsible) -->
                <div class="ct_advanced_toggle" id="ct_trunc_advanced_toggle">
                    <span><i class="fa-solid fa-cog"></i> Advanced Settings</span>
                    <i class="fa-solid fa-chevron-down"></i>
                </div>
                <div class="ct_advanced_content" id="ct_trunc_advanced_content" style="display: none;">
                    
                    <div class="ct_compact_setting">
                        <div class="ct_setting_header">
                            <span class="ct_setting_label">
                                Batch Size
                                <span class="ct_tooltip">
                                    <i class="fa-solid fa-circle-info ct_info_icon"></i>
                                    <span class="ct_tooltip_text">Messages to truncate at once. Larger batches are more cache-efficient but less granular.</span>
                                </span>
                            </span>
                            <span id="ct_batch_size_display" class="ct_setting_value">20</span>
                        </div>
                        <input id="ct_batch_size" class="ct_compact_slider" type="range" min="1" max="100" step="1" value="20" />
                    </div>

                    <div class="ct_compact_setting">
                        <div class="ct_setting_header">
                            <span class="ct_setting_label">
                                Min Messages
                                <span class="ct_tooltip">
                                    <i class="fa-solid fa-circle-info ct_info_icon"></i>
                                    <span class="ct_tooltip_text">Minimum messages to always keep in context. Safety limit to prevent over-truncation.</span>
                                </span>
                            </span>
                            <span id="ct_min_keep_display" class="ct_setting_value">10</span>
                        </div>
                        <input id="ct_min_keep" class="ct_compact_slider" type="range" min="1" max="100" step="1" value="10" />
                    </div>

                    <div class="ct_compact_checkbox">
                        <input id="ct_debug_truncation" type="checkbox" />
                        <label for="ct_debug_truncation">Debug Mode</label>
                        <span class="ct_tooltip ct_tooltip_right">
                            <i class="fa-solid fa-circle-info ct_info_icon"></i>
                            <span class="ct_tooltip_text">Enable detailed console logging for truncation calculations, token estimates, and calibration state changes.</span>
                        </span>
                    </div>

                </div>

            </div>

            <!-- ==================== QDRANT MEMORY TAB ==================== -->
            <div class="ct_tab_content" data-tab="qdrant">
                
                <!-- Master Enable/Disable -->
                <div class="ct_compact_checkbox">
                    <input id="ct_qdrant_enabled" type="checkbox" />
                    <label for="ct_qdrant_enabled"><strong>Enable Qdrant Memory</strong></label>
                    <span class="ct_tooltip ct_tooltip_right">
                        <i class="fa-solid fa-circle-info ct_info_icon"></i>
                        <span class="ct_tooltip_text">Enable semantic memory retrieval from Qdrant vector database for long-term memory.</span>
                    </span>
                </div>

                <hr class="ct_section_divider">

                <!-- Connection Settings -->
                <div class="ct_section_header">
                    <i class="fa-solid fa-plug"></i>
                    <span>Connection</span>
                </div>
                
                <div class="ct_compact_input">
                    <label for="ct_qdrant_url">
                        Qdrant URL
                        <span class="ct_tooltip">
                            <i class="fa-solid fa-circle-info ct_info_icon"></i>
                            <span class="ct_tooltip_text">URL of your Qdrant instance (e.g., http://localhost:6333)</span>
                        </span>
                    </label>
                    <input id="ct_qdrant_url" class="text_pole" type="text" placeholder="http://localhost:6333" />
                </div>

                <div class="ct_compact_input">
                    <label for="ct_qdrant_collection">
                        Collection Name
                        <span class="ct_tooltip">
                            <i class="fa-solid fa-circle-info ct_info_icon"></i>
                            <span class="ct_tooltip_text">Base name for collections. Character/chat suffix is appended automatically.</span>
                        </span>
                    </label>
                    <input id="ct_qdrant_collection" class="text_pole" type="text" placeholder="sillytavern_memories" />
                </div>

                <hr class="ct_section_divider">

                <!-- Embedding Settings (moved from Advanced) -->
                <div class="ct_section_header">
                    <i class="fa-solid fa-cube"></i>
                    <span>Embedding</span>
                </div>

                <div class="ct_compact_input">
                    <label for="ct_embedding_url">
                        Endpoint URL
                        <span class="ct_tooltip">
                            <i class="fa-solid fa-circle-info ct_info_icon"></i>
                            <span class="ct_tooltip_text">KoboldCPP or compatible endpoint (OpenAI-compatible format)</span>
                        </span>
                    </label>
                    <input id="ct_embedding_url" class="text_pole" type="text" placeholder="http://localhost:5001/api/extra/embeddings" />
                </div>

                <div class="ct_compact_input">
                    <label for="ct_embedding_api_key">
                        API Key (optional)
                        <span class="ct_tooltip">
                            <i class="fa-solid fa-circle-info ct_info_icon"></i>
                            <span class="ct_tooltip_text">Bearer token if your endpoint requires authentication</span>
                        </span>
                    </label>
                    <input id="ct_embedding_api_key" class="text_pole" type="password" placeholder="Leave empty if not required" />
                </div>

                <div class="ct_button_row">
                    <button id="ct_qdrant_test" class="menu_button" title="Test Qdrant connection">
                        <i class="fa-solid fa-plug"></i> Test Qdrant
                    </button>
                    <button id="ct_test_embedding" class="menu_button" title="Test embedding endpoint">
                        <i class="fa-solid fa-vial"></i> Test Embedding
                    </button>
                </div>
                <div id="ct_qdrant_status" class="ct_status_message" style="margin-top: 8px;"></div>
                <div id="ct_embedding_status" class="ct_status_message" style="margin-top: 4px;"></div>

                <hr class="ct_section_divider">

                <!-- Auto-Save Settings -->
                <div class="ct_section_header">
                    <i class="fa-solid fa-floppy-disk"></i>
                    <span>Auto-Save</span>
                </div>

                <div class="ct_compact_checkbox">
                    <input id="ct_auto_save_memories" type="checkbox" checked />
                    <label for="ct_auto_save_memories">Auto-Save Memories</label>
                    <span class="ct_tooltip ct_tooltip_right">
                        <i class="fa-solid fa-circle-info ct_info_icon"></i>
                        <span class="ct_tooltip_text">Automatically save messages to Qdrant as conversations happen.</span>
                    </span>
                </div>

                <div class="ct_compact_checkbox">
                    <input id="ct_save_user_messages" type="checkbox" checked />
                    <label for="ct_save_user_messages">Save User Messages</label>
                </div>

                <div class="ct_compact_checkbox">
                    <input id="ct_save_char_messages" type="checkbox" checked />
                    <label for="ct_save_char_messages">Save Character Messages</label>
                </div>

                <hr class="ct_section_divider">

                <!-- Quick Actions -->
                <div class="ct_button_row">
                    <button id="ct_index_chats" class="menu_button" title="Index all messages from current chat">
                        <i class="fa-solid fa-database"></i> Index Chat
                    </button>
                    <button id="ct_delete_collection" class="menu_button menu_button_danger" title="Delete all memories for this chat">
                        <i class="fa-solid fa-trash"></i> Delete Collection
                    </button>
                </div>

                <hr class="ct_section_divider">

                <!-- Advanced Settings (Collapsible) -->
                <div class="ct_advanced_toggle" id="ct_qdrant_advanced_toggle">
                    <span><i class="fa-solid fa-cog"></i> Advanced Settings</span>
                    <i class="fa-solid fa-chevron-down"></i>
                </div>
                <div class="ct_advanced_content" id="ct_qdrant_advanced_content" style="display: none;">
                    
                    <!-- Memory Retrieval Settings -->
                    <div class="ct_section_header" style="margin-top: 0;">
                        <i class="fa-solid fa-search"></i>
                        <span>Retrieval Settings</span>
                    </div>

                    <div class="ct_compact_setting">
                        <div class="ct_setting_header">
                            <span class="ct_setting_label">
                                Memories
                                <span class="ct_tooltip">
                                    <i class="fa-solid fa-circle-info ct_info_icon"></i>
                                    <span class="ct_tooltip_text">Maximum memories to retrieve per generation.</span>
                                </span>
                            </span>
                            <span id="ct_memory_limit_display" class="ct_setting_value">5</span>
                        </div>
                        <input id="ct_memory_limit" class="ct_compact_slider" type="range" min="1" max="20" value="5" />
                    </div>

                    <div class="ct_compact_setting">
                        <div class="ct_setting_header">
                            <span class="ct_setting_label">
                                Threshold
                                <span class="ct_tooltip">
                                    <i class="fa-solid fa-circle-info ct_info_icon"></i>
                                    <span class="ct_tooltip_text">Minimum similarity score (0.0-1.0). Higher = only highly relevant results.</span>
                                </span>
                            </span>
                            <span id="ct_score_threshold_display" class="ct_setting_value">0.30</span>
                        </div>
                        <input id="ct_score_threshold" class="ct_compact_slider" type="range" min="0" max="1" step="0.05" value="0.3" />
                    </div>

                    <div class="ct_compact_setting">
                        <div class="ct_setting_header">
                            <span class="ct_setting_label">
                                Position
                                <span class="ct_tooltip">
                                    <i class="fa-solid fa-circle-info ct_info_icon"></i>
                                    <span class="ct_tooltip_text">Insert memories N messages from the end of chat.</span>
                                </span>
                            </span>
                            <span id="ct_memory_position_display" class="ct_setting_value">2</span>
                        </div>
                        <input id="ct_memory_position" class="ct_compact_slider" type="range" min="1" max="30" value="2" />
                    </div>

                    <div class="ct_compact_setting">
                        <div class="ct_setting_header">
                            <span class="ct_setting_label">
                                Exclude Recent
                                <span class="ct_tooltip">
                                    <i class="fa-solid fa-circle-info ct_info_icon"></i>
                                    <span class="ct_tooltip_text">Don't retrieve memories from last N messages (already in context).</span>
                                </span>
                            </span>
                            <span id="ct_retain_recent_display" class="ct_setting_value">5</span>
                        </div>
                        <input id="ct_retain_recent" class="ct_compact_slider" type="range" min="0" max="50" value="5" />
                    </div>

                    <div class="ct_compact_setting">
                        <div class="ct_setting_header">
                            <span class="ct_setting_label">
                                Min Messages
                                <span class="ct_tooltip">
                                    <i class="fa-solid fa-circle-info ct_info_icon"></i>
                                    <span class="ct_tooltip_text">Only retrieve memories after chat has this many messages.</span>
                                </span>
                            </span>
                            <span id="ct_qdrant_min_messages_display" class="ct_setting_value">20</span>
                        </div>
                        <input id="ct_qdrant_min_messages" class="ct_compact_slider" type="range" min="0" max="100" step="5" value="20" />
                    </div>

                    <!-- Per-Message Vectorization -->
                    <div class="ct_section_header">
                        <i class="fa-solid fa-message"></i>
                        <span>Vectorization</span>
                    </div>

                    <div class="ct_compact_input">
                        <label for="ct_embedding_dimensions">
                            Dimensions (auto-detect)
                            <span class="ct_tooltip">
                                <i class="fa-solid fa-circle-info ct_info_icon"></i>
                                <span class="ct_tooltip_text">Vector size from your embedding model. Leave blank to auto-detect.</span>
                            </span>
                        </label>
                        <input id="ct_embedding_dimensions" class="text_pole" type="number" min="1" step="1" placeholder="Auto" />
                    </div>

                    <div class="ct_compact_setting">
                        <div class="ct_setting_header">
                            <span class="ct_setting_label">
                                Delay
                                <span class="ct_tooltip">
                                    <i class="fa-solid fa-circle-info ct_info_icon"></i>
                                    <span class="ct_tooltip_text">Don't vectorize messages within N positions from end. Allows edits without duplicates.</span>
                                </span>
                            </span>
                            <span id="ct_vectorization_delay_display" class="ct_setting_value">2</span>
                        </div>
                        <input id="ct_vectorization_delay" class="ct_compact_slider" type="range" min="0" max="10" value="2" />
                    </div>

                    <div class="ct_compact_checkbox">
                        <input id="ct_delete_on_message_delete" type="checkbox" checked />
                        <label for="ct_delete_on_message_delete">Delete Sync</label>
                        <span class="ct_tooltip ct_tooltip_right">
                            <i class="fa-solid fa-circle-info ct_info_icon"></i>
                            <span class="ct_tooltip_text">Remove Qdrant entries when messages are deleted in SillyTavern.</span>
                        </span>
                    </div>

                    <div class="ct_compact_checkbox">
                        <input id="ct_auto_dedupe" type="checkbox" checked />
                        <label for="ct_auto_dedupe">Auto-Deduplicate</label>
                        <span class="ct_tooltip ct_tooltip_right">
                            <i class="fa-solid fa-circle-info ct_info_icon"></i>
                            <span class="ct_tooltip_text">Automatically detect and clean up duplicate entries during search.</span>
                        </span>
                    </div>

                    <div class="ct_compact_checkbox">
                        <input id="ct_per_chat_collection" type="checkbox" checked />
                        <label for="ct_per_chat_collection">Per-Chat Collections</label>
                        <span class="ct_tooltip ct_tooltip_right">
                            <i class="fa-solid fa-circle-info ct_info_icon"></i>
                            <span class="ct_tooltip_text">Each chat gets its own collection (recommended).</span>
                        </span>
                    </div>

                    <div class="ct_compact_checkbox">
                        <input id="ct_debug_qdrant" type="checkbox" />
                        <label for="ct_debug_qdrant">Debug Mode</label>
                        <span class="ct_tooltip ct_tooltip_right">
                            <i class="fa-solid fa-circle-info ct_info_icon"></i>
                            <span class="ct_tooltip_text">Enable console logging for Qdrant operations and embeddings.</span>
                        </span>
                    </div>

                </div>

            </div>

            <!-- ==================== SYNERGY TAB ==================== -->
            <div class="ct_tab_content" data-tab="synergy">
                
                <div class="ct_info_box">
                    <i class="fa-solid fa-info-circle"></i>
                    <span>Synergy features combine truncation and Qdrant memory. Requires both systems enabled.</span>
                </div>

                <hr class="ct_section_divider">

                <!-- Summary-as-Chunk -->
                <div class="ct_section_header">
                    <i class="fa-solid fa-file-zipper"></i>
                    <span>Summary-as-Chunk</span>
                </div>
                
                <div class="ct_compact_checkbox">
                    <input id="ct_use_summaries_for_qdrant" type="checkbox" />
                    <label for="ct_use_summaries_for_qdrant">Use Summaries for Qdrant</label>
                    <span class="ct_tooltip ct_tooltip_right">
                        <i class="fa-solid fa-circle-info ct_info_icon"></i>
                        <span class="ct_tooltip_text">Index AI-generated summaries instead of raw messages. Faster/cheaper but may lose detail.</span>
                    </span>
                </div>

                <hr class="ct_section_divider">

                <!-- Memory-Aware Summarization -->
                <div class="ct_section_header">
                    <i class="fa-solid fa-brain"></i>
                    <span>Memory-Aware Summarization</span>
                </div>
                
                <div class="ct_compact_checkbox">
                    <input id="ct_memory_aware_summaries" type="checkbox" />
                    <label for="ct_memory_aware_summaries">Include Memories in Context</label>
                    <span class="ct_tooltip ct_tooltip_right">
                        <i class="fa-solid fa-circle-info ct_info_icon"></i>
                        <span class="ct_tooltip_text">Retrieve relevant memories when generating summaries for better context.</span>
                    </span>
                </div>

                <hr class="ct_section_divider">

                <!-- Token Accounting -->
                <div class="ct_section_header">
                    <i class="fa-solid fa-calculator"></i>
                    <span>Token Accounting</span>
                </div>
                
                <div class="ct_compact_checkbox">
                    <input id="ct_account_qdrant_tokens" type="checkbox" checked />
                    <label for="ct_account_qdrant_tokens">Account for Qdrant Tokens</label>
                    <span class="ct_tooltip ct_tooltip_right">
                        <i class="fa-solid fa-circle-info ct_info_icon"></i>
                        <span class="ct_tooltip_text">Adjust truncation target to account for injected Qdrant memories. Prevents context overflow.</span>
                    </span>
                </div>

                <hr class="ct_section_divider">

                <!-- Advanced Settings (Collapsible) -->
                <div class="ct_advanced_toggle" id="ct_synergy_advanced_toggle">
                    <span><i class="fa-solid fa-cog"></i> Advanced Settings</span>
                    <i class="fa-solid fa-chevron-down"></i>
                </div>
                <div class="ct_advanced_content" id="ct_synergy_advanced_content" style="display: none;">
                    <div class="ct_compact_checkbox">
                        <input id="ct_debug_synergy" type="checkbox" />
                        <label for="ct_debug_synergy">Debug Mode</label>
                        <span class="ct_tooltip ct_tooltip_right">
                            <i class="fa-solid fa-circle-info ct_info_icon"></i>
                            <span class="ct_tooltip_text">Enable console logging for synergy features (token accounting, summary-as-chunk)</span>
                        </span>
                    </div>
                </div>

            </div>

        </div>
    </div>
</div>
